{
  "meta": {
    "title": "Завеса: Костёр",
    "version": "1.0.0",
    "language": "ru",
    "dice": "d6",
    "modes": ["solo", "coop"],
    "coop_rules": {
      "vote": "majority",
      "tie_breaker": ["tag:mark.veil", "random"],
      "split_scenes": true,
      "comms": ["radio", "screen"]
    }
  },
  "state_schema": {
    "players": [
      {
        "id": "string",
        "name": "string",
        "fear": 0,
        "inventory": [],
        "runes": [],
        "marks": [],
        "memory": [],
        "effects": [],
        "flags": {}
      }
    ],
    "group": {
      "turn": 1,
      "scene_id": "1.1",
      "mode": "solo",
      "log": [],
      "random_seed": null
    }
  },
  "mechanics": {
    "fear": {
      "min": 0,
      "max": 6,
      "on_max": ["effect:panic", "disadvantage_next_roll"]
    },
    "rolls": {
      "check": {
        "dice": "1d6",
        "rules": [
          { "if": "result>=5", "outcome": "success" },
          { "if": "result==4", "outcome": "mixed" },
          { "if": "result<=3", "outcome": "fail" }
        ],
        "modifiers": [
          { "source": "fear>=4", "effect": -1 },
          { "source": "effect:focus", "effect": +1 },
          { "source": "item:serdtse_ekrana", "effect": +1 }
        ]
      }
    }
  },
  "items": {
    "vozvrat": { "id": "item:vozvrat", "name": "Возврат", "desc": "Единовременный откат к Ходу 15.", "charges": 1 },
    "serdtse_ekrana": { "id": "item:serdtse_ekrana", "name": "Сердце Экрана", "desc": "Силуэт, дающий власть над кадром.", "charges": 1 },
    "pepel": { "id": "item:pepel", "name": "Пепел", "desc": "Холодный прах из начала.", "charges": 1 },
    "zvuk_molitvy": { "id": "item:zvuk_molitvy", "name": "Звук Молитвы", "desc": "Слепой тон, режущий Завесу.", "charges": 1 },
    "radio": { "id": "item:radio", "name": "Радио", "desc": "Связь между локациями.", "charges": null }
  },
  "runes": {
    "r1": { "id": "r1", "name": "Руна Ока", "desc": "Видеть то, что прячется." },
    "r2": { "id": "r2", "name": "Руна Нити", "desc": "Чувствовать повтор." },
    "r3": { "id": "r3", "name": "Руна Тени", "desc": "Размывать себя." },
    "r4": { "id": "r4", "name": "Руна Голоса", "desc": "Звучать без рта." }
  },
  "effects": {
    "panic": { "id": "effect:panic", "name": "Паника", "desc": "Следующая проверка с помехой.", "duration": 1 },
    "focus": { "id": "effect:focus", "name": "Фокус", "desc": "Следующая проверка с преимуществом.", "duration": 1 }
  },
  "marks": {
    "veil": { "id": "mark:veil", "name": "Метка Завесы", "desc": "Завеса вас узнаёт." }
  },
  "random_hooks": [
    "Эхо шагов не совпадает с вашими.",
    "Дым от костра идёт вниз.",
    "На экране мигает чужое имя.",
    "Радио ловит собственное будущее.",
    "Тень моргает отдельно от вас."
  ],
  "nodes": [
    {
      "id": "1.1",
      "title": "Костёр",
      "turn": 1,
      "text": "Костёр горит тихо. Пепел холодный, но свежий. На экране — статический снег.",
      "setup": {
        "give_items": ["radio"],
        "group_effects": [],
        "on_first_enter": [
          { "type": "log", "message": "Вы просыпаетесь у костра." }
        ]
      },
      "choices": [
        {
          "id": "1.1.a",
          "label": "Потрогать пепел",
          "effects": [
            { "type": "give_item", "to": "any", "item": "pepel", "if_absent": true },
            { "type": "add_memory", "to": "any", "value": "Пепел хранит имена." }
          ],
          "next": "2.1"
        },
        {
          "id": "1.1.b",
          "label": "Настроить экран",
          "roll": { "type": "check", "skill": "wit" },
          "outcomes": {
            "success": {
              "effects": [
                { "type": "give_item", "to": "any", "item": "serdtse_ekrana", "if_absent": true },
                { "type": "add_rune", "to": "any", "rune": "r1" }
              ],
              "next": "2.2"
            },
            "mixed": {
              "effects": [
                { "type": "add_fear", "to": "group", "value": 1 },
                { "type": "add_rune", "to": "any", "rune": "r1" }
              ],
              "next": "2.2"
            },
            "fail": {
              "effects": [
                { "type": "add_fear", "to": "group", "value": 2 }
              ],
              "next": "2.3"
            }
          }
        },
        {
          "id": "1.1.c",
          "label": "Позвать в радио",
          "effects": [
            { "type": "add_effect", "to": "group", "effect": "focus", "duration": 1 },
            { "type": "random_hook" }
          ],
          "next": "2.4"
        }
      ]
    },
    {
      "id": "2.1",
      "title": "Имя в пепле",
      "turn": 2,
      "text": "Буквы проступают из серого: ‘...’ и ещё место для одного имени.",
      "choices": [
        {
          "id": "2.1.a",
          "label": "Написать своё имя",
          "effects": [
            { "type": "add_mark", "to": "any", "mark": "veil" },
            { "type": "add_memory", "to": "any", "value": "Завеса запомнила тебя." }
          ],
          "next": "3.1"
        },
        {
          "id": "2.1.b",
          "label": "Сдуть пепел",
          "roll": { "type": "check", "skill": "grit" },
          "outcomes": {
            "success": { "effects": [], "next": "3.2" },
            "mixed": { "effects": [{ "type": "add_fear", "to": "any", "value": 1 }], "next": "3.2" },
            "fail": { "effects": [{ "type": "add_fear", "to": "group", "value": 2 }], "next": "3.3" }
          }
        }
      ]
    },
    {
      "id": "2.2",
      "title": "Канал пойман",
      "turn": 2,
      "text": "Экран собирает изображение: костёр, но не ваш. В кадре нет вас.",
      "choices": [
        {
          "id": "2.2.a",
          "label": "Тянутся в экран",
          "conditions": [{ "type": "has_item", "to": "any", "item": "serdtse_ekrana" }],
          "effects": [{ "type": "add_memory", "to": "group", "value": "Кадр слушается руку." }],
          "next": "3.4"
        },
        {
          "id": "2.2.b",
          "label": "Выключить питание",
          "effects": [{ "type": "add_fear", "to": "any", "value": 1 }],
          "next": "3.5"
        }
      ]
    },
    {
      "id": "2.3",
      "title": "Шум сильнее",
      "turn": 2,
      "text": "Статик бьёт в виски. В шуме имя, которого вы не знаете.",
      "choices": [
        {
          "id": "2.3.a",
          "label": "Повторять имя",
          "effects": [{ "type": "add_rune", "to": "any", "rune": "r4" }],
          "next": "3.6"
        },
        {
          "id": "2.3.b",
          "label": "Отойти",
          "effects": [{ "type": "add_effect", "to": "any", "effect": "panic", "duration": 1 }],
          "next": "3.1"
        }
      ]
    },
    {
      "id": "2.4",
      "title": "Голоса в эфире",
      "turn": 2,
      "text": "Радио отвечает задержкой. Ваш голос звучит зрелее.",
      "choices": [
        {
          "id": "2.4.a",
          "label": "Слушать внимательно",
          "effects": [
            { "type": "add_rune", "to": "any", "rune": "r2" },
            { "type": "random_hook" }
          ],
          "next": "3.7"
        },
        {
          "id": "2.4.b",
          "label": "Просигналить трель",
          "effects": [{ "type": "give_item", "to": "group", "item": "zvuk_molitvy", "if_absent": true }],
          "next": "3.7"
        }
      ]
    },
    {
      "id": "3.1",
      "title": "Тропа от костра",
      "turn": 3,
      "text": "Тропа делится на две ленты. Одна пахнет дымом, другая — мокрой стеной.",
      "choices": [
        { "id": "3.1.a", "label": "К дыму", "next": "4.1" },
        { "id": "3.1.b", "label": "К стене", "next": "4.2" }
      ]
    },
    {
      "id": "3.2",
      "title": "Имени нет",
      "turn": 3,
      "text": "Пепел пуст. Пустота тоже читает.",
      "choices": [
        { "id": "3.2.a", "label": "Вернуться к экрану", "next": "4.3" },
        { "id": "3.2.b", "label": "Идти в туман", "next": "4.2" }
      ]
    },
    {
      "id": "3.3",
      "title": "Кашель",
      "turn": 3,
      "text": "Горло царапает гарь. В пепле проступает чужое имя.",
      "choices": [
        { "id": "3.3.a", "label": "Произнести его", "next": "4.4" },
        { "id": "3.3.b", "label": "Стереть ладонью", "next": "4.5" }
      ]
    },
    {
      "id": "3.4",
      "title": "Рука в кадре",
      "turn": 3,
      "text": "Кожа мурашками становится пикселями. Переход близок.",
      "choices": [
        {
          "id": "3.4.a",
          "label": "Войти целиком",
          "effects": [{ "type": "add_rune", "to": "any", "rune": "r3" }],
          "next": "4.6"
        },
        {
          "id": "3.4.b",
          "label": "Отдёрнуть руку",
          "effects": [{ "type": "add_fear", "to": "any", "value": 1 }],
          "next": "4.3"
        }
      ]
    },
    {
      "id": "3.5",
      "title": "Темнота экрана",
      "turn": 3,
      "text": "Чёрный экран отражает вас с задержкой в одно моргание.",
      "choices": [
        {
          "id": "3.5.a",
          "label": "Синхронизировать моргание",
          "roll": { "type": "check", "skill": "wit" },
          "outcomes": {
            "success": { "effects": [{ "type": "add_rune", "to": "any", "rune": "r2" }], "next": "4.7" },
            "mixed": { "effects": [{ "type": "add_fear", "to": "group", "value": 1 }], "next": "4.7" },
            "fail": { "effects": [{ "type": "add_effect", "to": "any", "effect": "panic", "duration": 1 }], "next": "4.3" }
          }
        },
        { "id": "3.5.b", "label": "Отвернуться", "next": "4.1" }
      ]
    },
    {
      "id": "3.6",
      "title": "Имя-пароль",
      "turn": 3,
      "text": "Имя становится ключом. Дверь в воздухе щёлкает.",
      "choices": [
        { "id": "3.6.a", "label": "Пройти", "next": "4.6" },
        { "id": "3.6.b", "label": "Запомнить и отойти", "next": "4.1" }
      ]
    },
    {
      "id": "3.7",
      "title": "Эхо будущего",
      "turn": 3,
      "text": "Голос обещает шёпотом: «в Ходе 15 вернёшься, если захочешь».",
      "choices": [
        { "id": "3.7.a", "label": "Согласиться", "effects": [{ "type": "give_item", "to": "any", "item": "vozvrat", "if_absent": true }], "next": "4.2" },
        { "id": "3.7.b", "label": "Промолчать", "next": "4.1" }
      ]
    },

    {
      "id": "4.1",
      "title": "Дымная тропа",
      "turn": 4,
      "text": "Запах костра ведёт кругами.",
      "choices": [
        { "id": "4.1.a", "label": "Идти дальше", "next": "5.1" },
        { "id": "4.1.b", "label": "Вернуться", "next": "5.2" }
      ]
    },
    {
      "id": "4.2",
      "title": "Мокрая стена",
      "turn": 4,
      "text": "Конденсат стекает как строки текста.",
      "choices": [
        { "id": "4.2.a", "label": "Прочесть капли", "roll": { "type": "check", "skill": "wit" }, "outcomes": {
          "success": { "effects": [{ "type": "add_rune", "to": "any", "rune": "r1" }], "next": "5.3" },
          "mixed": { "effects": [{ "type": "add_fear", "to": "any", "value": 1 }], "next": "5.3" },
          "fail": { "effects": [{ "type": "add_fear", "to": "group", "value": 2 }], "next": "5.2" }
        }},
        { "id": "4.2.b", "label": "Потрогать стену", "next": "5.4" }
      ]
    },
    {
      "id": "4.3",
      "title": "Снова экран",
      "turn": 4,
      "text": "Экран ждёт. Шум терпелив.",
      "choices": [
        { "id": "4.3.a", "label": "Искать другой канал", "next": "5.5" },
        { "id": "4.3.b", "label": "Выключить навсегда", "next": "5.6" }
      ]
    },
    {
      "id": "4.4",
      "title": "Чужое имя",
      "turn": 4,
      "text": "Воздух становится холоднее. Кто-то стал ближе.",
      "choices": [
        { "id": "4.4.a", "label": "Принять визит", "next": "5.7" },
        { "id": "4.4.b", "label": "Спрятаться", "next": "5.2" }
      ]
    },
    {
      "id": "4.5",
      "title": "Ладонь серая",
      "turn": 4,
      "text": "Пепел цепляется к коже.",
      "choices": [
        { "id": "4.5.a", "label": "Смыть", "next": "5.4" },
        { "id": "4.5.b", "label": "Оставить", "effects": [{ "type": "add_mark", "to": "any", "mark": "veil" }], "next": "5.1" }
      ]
    },
    {
      "id": "4.6",
      "title": "По ту сторону экрана",
      "turn": 4,
      "text": "Костёр там горит без вас. Места меньше, но ближе.",
      "choices": [
        { "id": "4.6.a", "label": "Занять пустое место", "next": "5.8" },
        { "id": "4.6.b", "label": "Вернуться обратно", "next": "5.2" }
      ]
    },
    {
      "id": "4.7",
      "title": "Сбой отражения",
      "turn": 4,
      "text": "Отражение улыбается раньше.",
      "choices": [
        { "id": "4.7.a", "label": "Улыбнуться в ответ", "next": "5.9" },
        { "id": "4.7.b", "label": "Погасить экран", "next": "5.6" }
      ]
    },

    {
      "id": "5.1",
      "title": "Круг за кругом",
      "turn": 5,
      "text": "Следы поверх следов. Вы были тут.",
      "choices": [
        { "id": "5.1.a", "label": "Оставить знак", "effects": [{ "type": "add_rune", "to": "group", "rune": "r2" }], "next": "6.1" },
        { "id": "5.1.b", "label": "Игнорировать", "next": "6.2" }
      ]
    },
    {
      "id": "5.2",
      "title": "Возврат к костру",
      "turn": 5,
      "text": "Костёр не тот же, но такой же.",
      "choices": [
        { "id": "5.2.a", "label": "Смотреть в огонь", "next": "6.3" },
        { "id": "5.2.b", "label": "Говорить в радио", "next": "6.4" }
      ]
    },
    {
      "id": "5.3",
      "title": "Строки воды",
      "turn": 5,
      "text": "Капли подсказывают короткий путь.",
      "choices": [
        { "id": "5.3.a", "label": "Коротким путём", "next": "6.5" },
        { "id": "5.3.b", "label": "Осторожно обратно", "next": "6.2" }
      ]
    },
    {
      "id": "5.4",
      "title": "Руки в воде",
      "turn": 5,
      "text": "Вода отражает звук, не образ.",
      "choices": [
        { "id": "5.4.a", "label": "Слышать себя", "effects": [{ "type": "give_item", "to": "any", "item": "zvuk_molitvy", "if_absent": true }], "next": "6.1" },
        { "id": "5.4.b", "label": "Плеск — знак", "next": "6.2" }
      ]
    },
    {
      "id": "5.5",
      "title": "Тонкая настройка",
      "turn": 5,
      "text": "Частоты складываются в узор.",
      "choices": [
        { "id": "5.5.a", "label": "Сохранить узор", "effects": [{ "type": "add_rune", "to": "any", "rune": "r1" }], "next": "6.5" },
        { "id": "5.5.b", "label": "Разрушить узор", "effects": [{ "type": "add_fear", "to": "group", "value": 1 }], "next": "6.2" }
      ]
    },
    {
      "id": "5.6",
      "title": "Пустой экран",
      "turn": 5,
      "text": "Тишина шуршит.",
      "choices": [
        { "id": "5.6.a", "label": "Прислушаться", "next": "6.3" },
        { "id": "5.6.b", "label": "Отойти от экрана", "next": "6.2" }
      ]
    },
    {
      "id": "5.7",
      "title": "Гость у костра",
      "turn": 5,
      "text": "Присядет тот, чьё имя вы сказали.",
      "choices": [
        { "id": "5.7.a", "label": "Спросить путь", "next": "6.5" },
        { "id": "5.7.b", "label": "Молчать вместе", "next": "6.3" }
      ]
    },
    {
      "id": "5.8",
      "title": "Чужое место занято",
      "turn": 5,
      "text": "Кадр принимает вас. Здесь кадры главнее тел.",
      "choices": [
        { "id": "5.8.a", "label": "Закрепиться", "effects": [{ "type": "add_mark", "to": "any", "mark": "veil" }], "next": "6.6" },
        { "id": "5.8.b", "label": "Оставить якорь", "effects": [{ "type": "add_memory", "to": "group", "value": "Вернуться будет легче." }], "next": "6.2" }
      ]
    },
    {
      "id": "5.9",
      "title": "Договор с отражением",
      "turn": 5,
      "text": "Оно кивает. Вы — тоже.",
      "choices": [
        { "id": "5.9.a", "label": "Поменяться местами", "next": "6.6" },
        { "id": "5.9.b", "label": "Сохранить дистанцию", "next": "6.2" }
      ]
    },

    {
      "id": "6.1",
      "title": "Метки на круге",
      "turn": 6,
      "text": "Знаки остаются даже в тумане.",
      "choices": [
        { "id": "6.1.a", "label": "Следовать меткам", "next": "7.1" },
        { "id": "6.1.b", "label": "Сбить свой след", "next": "7.2" }
      ]
    },
    {
      "id": "6.2",
      "title": "Возврат без ответа",
      "turn": 6,
      "text": "Каждый шаг — как было. Но что-то утекает.",
      "choices": [
        { "id": "6.2.a", "label": "Собраться у костра", "next": "7.3" },
        { "id": "6.2.b", "label": "Разойтись локациями", "split": true, "next_parallel": ["7.4", "7.5"] }
      ]
    },
    {
      "id": "6.3",
      "title": "Смотреть в огонь",
      "turn": 6,
      "text": "Искры складываются в буквы.",
      "choices": [
        { "id": "6.3.a", "label": "Читать искры", "next": "7.1" },
        { "id": "6.3.b", "label": "Закрыть глаза", "next": "7.2" }
      ]
    },
    {
      "id": "6.4",
      "title": "Дальняя связь",
      "turn": 6,
      "text": "Ответы приходят до вопросов.",
      "choices": [
        { "id": "6.4.a", "label": "Задать неверный вопрос", "effects": [{ "type": "add_rune", "to": "any", "rune": "r4" }], "next": "7.5" },
        { "id": "6.4.b", "label": "Замолчать", "next": "7.3" }
      ]
    },
    {
      "id": "6.5",
      "title": "Короткий путь",
      "turn": 6,
      "text": "Куда бы вы ни шли, доходите к финалу раньше.",
      "choices": [
        { "id": "6.5.a", "label": "Принять ускорение", "next": "13.1" },
        { "id": "6.5.b", "label": "Сбросить темп", "next": "7.2" }
      ]
    },
    {
      "id": "6.6",
      "title": "Замещение",
      "turn": 6,
      "text": "Кто-то из вас — уже не вы.",
      "choices": [
        { "id": "6.6.a", "label": "Проверить знак на коже", "next": "7.6" },
        { "id": "6.6.b", "label": "Игнорировать подмену", "next": "7.2" }
      ]
    },

    {
      "id": "7.1",
      "title": "Нить ведёт",
      "turn": 7,
      "text": "Руна Нити тянет к развязке.",
      "choices": [
        { "id": "7.1.a", "label": "Следовать", "next": "8.1" },
        { "id": "7.1.b", "label": "Оборвать", "effects": [{ "type": "add_fear", "to": "group", "value": 1 }], "next": "8.2" }
      ]
    },
    {
      "id": "7.2",
      "title": "Отказ пути",
      "turn": 7,
      "text": "Когда не выбираешь — тоже выбираешь.",
      "choices": [
        { "id": "7.2.a", "label": "Случайный крюк", "random_next": ["8.1", "8.2", "8.3"] },
        { "id": "7.2.b", "label": "Вернуться к костру", "next": "8.3" }
      ]
    },
    {
      "id": "7.3",
      "title": "Сбор у огня",
      "turn": 7,
      "text": "Все на месте. Или почти все.",
      "choices": [
        { "id": "7.3.a", "label": "Пересчитать", "next": "8.3" },
        { "id": "7.3.b", "label": "Делиться находками", "effects": [{ "type": "sync_inventories" }], "next": "8.1" }
      ]
    },
    {
      "id": "7.4",
      "title": "Лес",
      "turn": 7,
      "text": "Деревья как мачты. Радио шипит.",
      "choices": [
        { "id": "7.4.a", "label": "Говорить кратко", "next": "8.4" },
        { "id": "7.4.b", "label": "Молчать", "next": "8.2" }
      ]
    },
    {
      "id": "7.5",
      "title": "Бетон",
      "turn": 7,
      "text": "Стены тёплые, но мокрые.",
      "choices": [
        { "id": "7.5.a", "label": "Рисовать руной", "effects": [{ "type": "add_rune", "to": "any", "rune": "r3" }], "next": "8.4" },
        { "id": "7.5.b", "label": "Искать дверь", "next": "8.2" }
      ]
    },
    {
      "id": "7.6",
      "title": "Метка на коже",
      "turn": 7,
      "text": "Под пальцами шепчет символ.",
      "choices": [
        { "id": "7.6.a", "label": "Принять метку", "effects": [{ "type": "add_mark", "to": "any", "mark": "veil" }], "next": "8.1" },
        { "id": "7.6.b", "label": "Стереть до крови", "effects": [{ "type": "add_fear", "to": "any", "value": 2 }], "next": "8.2" }
      ]
    },

    {
      "id": "8.1",
      "title": "Сбор знаков",
      "turn": 8,
      "text": "Трое рун — почти ключ.",
      "choices": [
        { "id": "8.1.a", "label": "Проверить руны", "next": "9.1" },
        { "id": "8.1.b", "label": "Не торопиться", "next": "9.2" }
      ]
    },
    {
      "id": "8.2",
      "title": "Шаги распадаются",
      "turn": 8,
      "text": "Кто-то идёт не там, где должен.",
      "choices": [
        { "id": "8.2.a", "label": "Собраться по радио", "next": "9.2" },
        { "id": "8.2.b", "label": "Идти дальше врозь", "split": true, "next_parallel": ["9.3", "9.4"] }
      ]
    },
    {
      "id": "8.3",
      "title": "Костёр держит",
      "turn": 8,
      "text": "Если остаться — вернёшься.",
      "choices": [
        { "id": "8.3.a", "label": "Остаться дольше", "next": "9.2" },
        { "id": "8.3.b", "label": "В путь", "next": "9.1" }
      ]
    },
    {
      "id": "8.4",
      "title": "Связь тонка",
      "turn": 8,
      "text": "Голоса почти совпали.",
      "choices": [
        { "id": "8.4.a", "label": "Синхронизировать шаги", "next": "9.1" },
        { "id": "8.4.b", "label": "Сорвать синхру", "effects": [{ "type": "add_fear", "to": "group", "value": 1 }], "next": "9.2" }
      ]
    },

    {
      "id": "9.1",
      "title": "Порог Завесы",
      "turn": 9,
      "text": "Руны звучат вместе.",
      "choices": [
        { "id": "9.1.a", "label": "Сохранить звучание", "next": "10.1" },
        { "id": "9.1.b", "label": "Разорвать хор", "next": "10.2" }
      ]
    },
    {
      "id": "9.2",
      "title": "Ещё не время",
      "turn": 9,
      "text": "Огрызок пути между вами и решением.",
      "choices": [
        { "id": "9.2.a", "label": "Ускориться", "next": "10.1" },
        { "id": "9.2.b", "label": "Замедлиться", "next": "10.2" }
      ]
    },
    {
      "id": "9.3",
      "title": "Лес глушит",
      "turn": 9,
      "text": "Тишина давит на барабанные перепонки.",
      "choices": [
        { "id": "9.3.a", "label": "Крикнуть", "effects": [{ "type": "add_fear", "to": "any", "value": 1 }], "next": "10.2" },
        { "id": "9.3.b", "label": "Идти тихо", "next": "10.1" }
      ]
    },
    {
      "id": "9.4",
      "title": "Бетон поёт",
      "turn": 9,
      "text": "Стены возвращают шаг через два шага.",
      "choices": [
        { "id": "9.4.a", "label": "Подстроиться", "next": "10.1" },
        { "id": "9.4.b", "label": "Сбиться", "next": "10.2" }
      ]
    },

    {
      "id": "10.1",
      "title": "Решение близко",
      "turn": 10,
      "text": "Тень костра длинная.",
      "choices": [
        { "id": "10.1.a", "label": "Готовиться к финалу", "next": "11.1" },
        { "id": "10.1.b", "label": "Отвлечься на малое", "next": "11.2" }
      ]
    },
    {
      "id": "10.2",
      "title": "Сомнение",
      "turn": 10,
      "text": "Сомнение — тоже дверь.",
      "choices": [
        { "id": "10.2.a", "label": "Открыть сомнение", "next": "11.2" },
        { "id": "10.2.b", "label": "Закрыть сомнение", "next": "11.1" }
      ]
    },

    {
      "id": "11.1",
      "title": "Сбор ключей",
      "turn": 11,
      "text": "Проверьте: руны, метки, предметы.",
      "choices": [
        { "id": "11.1.a", "label": "У нас достаточно", "next": "12.1" },
        { "id": "11.1.b", "label": "Ещё поискать", "next": "12.2" }
      ]
    },
    {
      "id": "11.2",
      "title": "Малые дела",
      "turn": 11,
      "text": "Малое тянет время.",
      "choices": [
        { "id": "11.2.a", "label": "Принести хворост", "next": "12.2" },
        { "id": "11.2.b", "label": "Слушать радио", "next": "12.1" }
      ]
    },

    {
      "id": "12.1",
      "title": "Порог Решения",
      "turn": 12,
      "text": "Три тропы расходятся от костра.",
      "choices": [
        { "id": "12.1.a", "label": "Стереть других (соло-победа)", "conditions": [
          { "type": "any_of", "checks": [
            { "type": "has_item", "to": "any", "item": "vozvrat" },
            { "type": "has_item", "to": "any", "item": "serdtse_ekrana" }
          ]}
        ], "next": "14.1" },
        { "id": "12.1.b", "label": "Остаться в Завесе (петля)", "next": "14.2" },
        { "id": "12.1.c", "label": "Сломать Завесу (конец цикла)", "conditions": [
          { "type": "group_runes_count", "count": 3 },
          { "type": "any_of", "checks": [
            { "type": "has_item", "to": "group", "item": "pepel" },
            { "type": "has_item", "to": "group", "item": "zvuk_molitvy" }
          ]}
        ], "next": "14.3" }
      ]
    },
    {
      "id": "12.2",
      "title": "Ещё круг",
      "turn": 12,
      "text": "Вы тянете время — время тянет вас.",
      "choices": [
        { "id": "12.2.a", "label": "Передумать и решать", "next": "12.1" },
        { "id": "12.2.b", "label": "Скользнуть кратчайшим", "next": "13.1" }
      ]
    },

    {
      "id": "13.1",
      "title": "Сокращённый финал",
      "turn": 13,
      "text": "Шаг — и вы у выбора.",
      "choices": [
        { "id": "13.1.a", "label": "Стереть других", "conditions": [
          { "type": "any_of", "checks": [
            { "type": "has_item", "to": "any", "item": "vozvrat" },
            { "type": "has_item", "to": "any", "item": "serdtse_ekrana" }
          ]}
        ], "next": "14.1" },
        { "id": "13.1.b", "label": "Остаться в Завесе", "next": "14.2" },
        { "id": "13.1.c", "label": "Сломать Завесу", "conditions": [
          { "type": "group_runes_count", "count": 3 },
          { "type": "any_of", "checks": [
            { "type": "has_item", "to": "group", "item": "pepel" },
            { "type": "has_item", "to": "group", "item": "zvuk_molitvy" }
          ]}
        ], "next": "14.3" }
      ]
    },

    {
      "id": "14.1",
      "title": "Финал: Стереть других",
      "turn": 14,
      "text": "Кадр за кадром остальные становятся фонами.",
      "effects": [
        { "type": "set_flag", "scope": "group", "key": "ending", "value": "solo_victory" }
      ],
      "choices": [
        {
          "id": "14.1.a",
          "label": "Подтвердить стирание",
          "effects": [
            { "type": "remove_players_except", "to": "chooser" },
            { "type": "log", "message": "Победа одиночки." }
          ],
          "next": "15.0"
        },
        { "id": "14.1.b", "label": "Отменить", "next": "12.1" }
      ]
    },
    {
      "id": "14.2",
      "title": "Финал: Остаться в Завесе",
      "turn": 14,
      "text": "Все живы. Все здесь. Круг замкнётся.",
      "effects": [
        { "type": "set_flag", "scope": "group", "key": "ending", "value": "loop" }
      ],
      "choices": [
        {
          "id": "14.2.a",
          "label": "Принять петлю",
          "effects": [
            { "type": "set_turn", "value": 15 }
          ],
          "next": "15.1"
        },
        { "id": "14.2.b", "label": "Передумать", "next": "12.1" }
      ]
    },
    {
      "id": "14.3",
      "title": "Финал: Сломать Завесу",
      "turn": 14,
      "text": "Руны звучат, пепел и молитва режут ткань.",
      "effects": [
        { "type": "set_flag", "scope": "group", "key": "ending", "value": "break" }
      ],
      "choices": [
        {
          "id": "14.3.a",
          "label": "Разорвать цикл",
          "effects": [
            { "type": "kill_all" },
            { "type": "log", "message": "Тишина без шума." }
          ],
          "next": "15.x"
        },
        { "id": "14.3.b", "label": "Отступить", "next": "12.1" }
      ]
    },

    {
      "id": "15.0",
      "title": "Ход 15: Один у костра",
      "turn": 15,
      "text": "Костёр горит. Экран показывает только тебя.",
      "choices": [
        { "id": "15.0.a", "label": "Завершить игру", "next": null },
        { "id": "15.0.b", "label": "Смотреть в огонь ещё", "next": null }
      ]
    },
    {
      "id": "15.1",
      "title": "Ход 15: Финал-петля",
      "turn": 15,
      "text": "Костёр снова горит. Всё как в начале. На пепле выбито одно имя — твоё.",
      "setup": {
        "on_enter": [
          { "type": "if_any_has_item", "item": "vozvrat", "then": [{ "type": "consume_item", "to": "any", "item": "vozvrat" }, { "type": "log", "message": "Возврат срабатывает именно сейчас." }] },
          { "type": "set_scene_if_flag", "flag_key": "copies_evil", "flag_value": true, "scene": "13.2" }
        ]
      },
      "choices": [
        { "id": "15.1.a", "label": "Начать сначала", "next": "1.1" },
        { "id": "15.1.b", "label": "Остаться у огня", "next": null }
      ]
    },
    {
      "id": "15.x",
      "title": "Абсолютный финал",
      "turn": 15,
      "text": "Экран гаснет для всех: тишина без шума.",
      "choices": [
        { "id": "15.x.a", "label": "Завершить", "next": null }
      ]
    }
  ],
  "bot_api_contract": {
    "enter_node": {
      "request": { "scene_id": "string", "state": "state_schema" },
      "response": {
        "scene": { "id": "string", "title": "string", "text": "string", "turn": "number" },
        "choices": [{ "id": "string", "label": "string", "available": true, "reason_unavailable": null }],
        "effects_applied": [],
        "state": "state_schema"
      }
    },
    "choose": {
      "request": { "choice_id": "string", "state": "state_schema" },
      "response": {
        "roll": { "rolled": null, "outcome": null },
        "effects_applied": [],
        "next_scene_id": "string",
        "state": "state_schema"
      }
    },
    "roll": {
      "request": { "type": "check", "modifiers": ["auto"], "seed": "optional" },
      "response": { "d6": 1, "total": 1, "outcome": "success|mixed|fail" }
    }
  }
}
